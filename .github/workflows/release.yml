name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Update .csproj version
      run: |
        VERSION=${{ steps.version.outputs.version }}
        sed -i "s/<AssemblyVersion>.*<\/AssemblyVersion>/<AssemblyVersion>$VERSION.0<\/AssemblyVersion>/" Jellyfin.Plugin.UserRatings.csproj
        sed -i "s/<FileVersion>.*<\/FileVersion>/<FileVersion>$VERSION.0<\/FileVersion>/" Jellyfin.Plugin.UserRatings.csproj

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build -c Release --no-restore

    - name: Create ZIP
      run: |
        cd bin/Release/net8.0
        zip -j Jellyfin.Plugin.UserRatings.zip Jellyfin.Plugin.UserRatings.dll
        cd ../../..

    - name: Calculate checksum
      id: checksum
      run: |
        CHECKSUM=$(md5sum bin/Release/net8.0/Jellyfin.Plugin.UserRatings.zip | awk '{print $1}')
        echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
        echo "Checksum: $CHECKSUM"

    - name: Update manifest.json
      run: |
        VERSION=${{ steps.version.outputs.version }}
        CHECKSUM=${{ steps.checksum.outputs.checksum }}
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Update manifest with new version
        cat > manifest.json << EOF
        [
          {
            "guid": "b8c5d3e7-4f6a-8b9c-1d2e-3f4a5b6c7d8e",
            "name": "User Ratings",
            "description": "Allow users to rate and review movies, TV shows, and music. See what other users on your server think!",
            "overview": "Social rating system for Jellyfin - rate content and see ratings from other users on your server",
            "owner": "davidhenry",
            "category": "General",
            "versions": [
              {
                "version": "$VERSION.0",
                "changelog": "Release $VERSION",
                "targetAbi": "10.9.0.0",
                "sourceUrl": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Jellyfin.Plugin.UserRatings.zip",
                "checksum": "$CHECKSUM",
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
        ]
        EOF

    - name: Commit and push version files
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add manifest.json Jellyfin.Plugin.UserRatings.csproj
        git commit -m "Update manifest and csproj for version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
        git push origin HEAD:main || echo "Nothing to push"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: bin/Release/net8.0/Jellyfin.Plugin.UserRatings.zip
        body: |
          ## Jellyfin User Ratings v${{ steps.version.outputs.version }}
          
          ### Installation
          Add this repository to Jellyfin:
          ```
          https://raw.githubusercontent.com/${{ github.repository }}/main/manifest.json
          ```
          
          ### Checksums
          - MD5: ${{ steps.checksum.outputs.checksum }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

